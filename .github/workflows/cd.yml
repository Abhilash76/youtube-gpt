name: CD Pipeline

on:
  push:
    branches: [ main, master ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3

    - name: Login to Docker Hub
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    - name: Build and push Backend
      uses: docker/build-push-action@v4
      with:
        context: .
        file: Dockerfile.backend
        push: true
        tags: ${{ secrets.DOCKER_USERNAME }}/class-gpt-backend:latest

    - name: Build and push Frontend
      uses: docker/build-push-action@v4
      with:
        context: ./frontend
        file: ./frontend/Dockerfile
        push: true
        tags: ${{ secrets.DOCKER_USERNAME }}/class-gpt-frontend:latest

    - name: Set up Kubeconfig
      run: |
        mkdir -p $HOME/.kube
        echo "${{ secrets.KUBE_CONFIG }}" > $HOME/.kube/config
        # Verify if the config is valid and doesn't contain local paths
        if grep -q "C:\\\\" $HOME/.kube/config; then
          echo "Error: KUBE_CONFIG secret contains Windows paths. Please use 'kubectl config view --flatten --minify' to generate a portable config."
          exit 1
        fi

    - name: Deploy to Kubernetes
      run: |
        # Replace ${DOCKER_USERNAME} in manifests
        sed -i "s/\${DOCKER_USERNAME}/${{ secrets.DOCKER_USERNAME }}/g" k8s/*.yaml
        
        # Apply manifests
        kubectl apply -f k8s/
